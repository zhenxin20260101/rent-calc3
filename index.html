<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>租金評定試算系統 v6.0</title>
    <style>
        :root { --primary: #2c3e50; --bg: #f0f4f8; --white: #ffffff; --accent: #3498db; --helper-bg: #fff9db; --date-bg: #e3f2fd; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 25px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
        
        .card { padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; background-color: #fff; }
        .input-group { background-color: #f8fbff; }
        
        /* 區塊樣式 */
        .helper-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid transparent; }
        .area-helper { background-color: var(--helper-bg); border-color: #f5e79e; }
        .date-helper { background-color: var(--date-bg); border-color: #bbdefb; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.95rem; }
        select, input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        .result-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .result-label { color: #666; }
        .result-value { font-weight: bold; color: var(--primary); font-size: 1.1rem; }

        #statusBox { text-align: center; padding: 20px; border-radius: 8px; font-weight: bold; margin-top: 25px; font-size: 1.25rem; }
        .status-init { background-color: #e9ecef; color: #495057; }
        .status-normal { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .btn-reset { width: 100%; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        .unit { font-size: 0.8rem; margin-left: 5px; color: #888; }
        .small-hint { font-size: 0.8rem; font-weight: normal; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>租金評定試算系統 (含屋齡自動計算)</h2>
    
    <div class="grid">
        <div class="card input-group">
            <label>1. 選擇縣市</label>
            <select id="city" onchange="initDistricts()">
                <option value="桃園市">桃園市</option>
                <option value="彰化縣">彰化縣</option>
                <option value="南投縣">南投縣</option>
            </select>

            <label>2. 選擇鄉鎮市區</label>
            <select id="district" onchange="calculate()"></select>

            <label>3. 案件類型</label>
            <select id="caseType" onchange="calculate()">
                <option value="整層">整層 (一般住宅)</option>
                <option value="套房">套房</option>
            </select>

            <div class="helper-box area-helper">
                <label>面積換算助手 <span class="small-hint">(依謄本紅字輸入)</span></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <input type="number" id="h_main" placeholder="主建物" oninput="calcAreaHelper()">
                    <input type="number" id="h_sub" placeholder="附屬" oninput="calcAreaHelper()">
                    <input type="number" id="h_common1" placeholder="共有1" oninput="calcAreaHelper()">
                    <input type="number" id="h_common2" placeholder="共有2" oninput="calcAreaHelper()">
                </div>
                <div style="text-align: right; font-size: 0.9rem;">換算結果：<b id="helperResult">0</b> 坪</div>
            </div>

            <div class="helper-box date-helper">
                <label>屋齡計算方式</label>
                <select id="ageMode" onchange="toggleAgeInput()">
                    <option value="manual">手動輸入屋齡</option>
                    <option value="date">按建築完成日期計算</option>
                </select>
                
                <div id="manualAgeGroup">
                    <label>輸入屋齡 (年)</label>
                    <input type="number" id="age" value="0" min="0" oninput="calculate()">
                </div>
                
                <div id="dateAgeGroup" style="display:none;">
                    <label>建築完成日期 <span class="small-hint">(如：0850625)</span></label>
                    <input type="text" id="buildDate" placeholder="請輸入民國年月日" oninput="calcAgeByDate()">
                    <div style="font-size: 0.85rem; color: #0d47a1;">自動計算屋齡：<b id="autoAgeRes">0</b> 年</div>
                </div>
            </div>

            <label>坪數 (坪)</label>
            <input type="number" id="area" value="0" min="0" step="0.01" oninput="calculate()">

            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>區位調整 (%)</label>
                    <select id="locAdj" onchange="calculate()">
                        <option value="0">0%</option><option value="3">3%</option><option value="5">5%</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>裝修調整 (%)</label>
                    <select id="renAdj" onchange="calculate()">
                        <option value="0">0%</option><option value="3">3%</option><option value="5">5%</option>
                    </select>
                </div>
            </div>

            <label>簽約租金 (每月/元)</label>
            <input type="number" id="rent" placeholder="輸入實際合約金額" oninput="calculate()">
        </div>

        <div class="card">
            <div class="result-row">
                <span class="result-label">參考單價 (未調整)</span>
                <span class="result-value"><span id="resRef">0</span><span class="unit">元/坪</span></span>
            </div>
            <div class="result-row">
                <span class="result-label">核定租金上限</span>
                <span class="result-value" style="color: #d35400; font-size: 1.4rem;"><span id="resMax">0</span><span class="unit">元</span></span>
            </div>
            <div id="statusBox" class="status-init">請輸入資料</div>
            
            <button class="btn-reset" onclick="location.reload()">重設所有欄位</button>
            
            <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem; color: #666; line-height: 1.6;">
                <strong>操作提醒：</strong><br>
                1. <strong>屋齡計算</strong>：若輸入「0850625」，系統會自動識別為民國 85 年，計算至今年 (113年) 為 28 年屋齡。<br>
                2. <strong>數據來源</strong>：依據 之評定表。<br>
                3. <strong>上限設定</strong>：<br>
                - 桃園：35,000 / 21,000<br>
                - 彰投：22,000 / 13,000
            </div>
        </div>
    </div>
</div>

<script>
// 數據與之前相同... (略過顯示以節省空間，但完整程式碼會包含)
const masterData = { "桃園市": [...], "彰化縣": [...], "南投縣": [...] }; 

// 屋齡計算邏輯
function toggleAgeInput() {
    const mode = document.getElementById('ageMode').value;
    document.getElementById('manualAgeGroup').style.display = (mode === 'manual') ? 'block' : 'none';
    document.getElementById('dateAgeGroup').style.display = (mode === 'date') ? 'block' : 'none';
    calculate();
}

function calcAgeByDate() {
    const dateStr = document.getElementById('buildDate').value;
    // 取得當前民國年份 (如 2024年 = 民國 113年)
    const currentROCYear = new Date().getFullYear() - 1911;
    
    if (dateStr.length >= 3) {
        // 抓取前三位或前二位作為年份 (處理如 085 或 102)
        let buildYear = 0;
        if (dateStr.length === 7) { // 格式如 0850625
            buildYear = parseInt(dateStr.substring(0, 3));
        } else if (dateStr.length === 6) { // 格式如 850625
            buildYear = parseInt(dateStr.substring(0, 2));
        } else {
            buildYear = parseInt(dateStr);
        }

        const calculatedAge = Math.max(0, currentROCYear - buildYear);
        document.getElementById('autoAgeRes').innerText = calculatedAge;
        document.getElementById('age').value = calculatedAge; // 隱形同步到主屋齡欄位
        calculate();
    }
}

// 面積與計算邏輯 (整合上述版本)
function calcAreaHelper() {
    const main = parseFloat(document.getElementById('h_main').value) || 0;
    const sub = parseFloat(document.getElementById('h_sub').value) || 0;
    const c1 = parseFloat(document.getElementById('h_common1').value) || 0;
    const c2 = parseFloat(document.getElementById('h_common2').value) || 0;
    const pings = Math.round((main + sub + c1 + c2) * 0.3025 * 100) / 100;
    document.getElementById('helperResult').innerText = pings;
    document.getElementById('area').value = pings;
    calculate();
}

// ... 剩餘 initDistricts 與 calculate 函數 (包含分區上限邏輯) ...
</script>
</body>
</html>

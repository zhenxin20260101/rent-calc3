<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>租金評定系統 v12.0 謄本精確版</title>
    <style>
        :root { --primary: #2c3e50; --bg: #f2f5f8; --accent: #3498db; --danger: #e74c3c; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; position: relative; }
        .mode-toggle { position: absolute; right: 10px; top: 10px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        
        .main-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 0; }
        .input-side { padding: 20px; border-right: 1px solid #eee; }
        .result-side { padding: 20px; background: #fafbfc; }

        @media (max-width: 850px) { .main-grid { grid-template-columns: 1fr; } .input-side { border-right: none; } }
        body.mobile-mode .container { max-width: 480px; }
        body.mobile-mode .main-grid { grid-template-columns: 1fr; }

        .section-title { font-size: 1rem; color: var(--accent); font-weight: 800; margin: 15px 0 10px 0; border-left: 5px solid var(--accent); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: bold; color: #4a5568; }
        select, input { width: 100%; height: 40px; padding: 0 10px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        /* 謄本計算器表格 */
        #areaCalculator { background: #fff; border: 2px solid #3498db; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .calc-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .calc-table th { background: #f8fafc; padding: 8px; border: 1px solid #cbd5e0; }
        .calc-table td { padding: 5px; border: 1px solid #cbd5e0; text-align: center; }
        .calc-table input { height: 32px; margin-bottom: 0; border: 1px solid #ddd; text-align: center; color: #e74c3c; font-weight: bold; }
        .bg-gray { background: #f1f5f9; font-weight: bold; }
        
        .calc-summary { background: #fdf2f2; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #feb2b2; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .summary-item { font-size: 0.85rem; color: #2d3748; }
        .summary-item span { display: block; font-size: 1.1rem; font-weight: 900; color: #c53030; }

        .result-card { background: #fff; border: 2px solid #bee3f8; border-radius: 12px; padding: 15px; position: sticky; top: 10px; }
        .res-max-val { font-size: 2rem; font-weight: 900; color: var(--danger); }
        #statusBox { text-align: center; padding: 15px; border-radius: 10px; font-weight: 800; margin-top: 10px; }
        .status-normal { background: #c6f6d5; color: #22543d; }
        .status-danger { background: #fed7d7; color: #822727; }
        .btn-apply { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body class="mobile-mode">

<div class="container">
    <div class="header">
        <button class="mode-toggle" onclick="toggleView()">切換模式</button>
        <h2>租金評定系統 v12.0 (謄本整合版)</h2>
    </div>
    
    <div class="main-grid">
        <div class="input-side">
            <div class="section-title">
                面積換算 (依謄本內容填入)
            </div>
            
            <div id="areaCalculator">
                <table class="calc-table">
                    <thead>
                        <tr><th>項目</th><th>面積(m²)</th><th>分母</th><th>分子</th></tr>
                    </thead>
                    <tbody>
                        <tr><td class="bg-gray">主建物</td><td><input type="number" id="mMain" value="63.66" oninput="runAreaCalc()"></td><td>1</td><td>1</td></tr>
                        <tr><td class="bg-gray">陽台</td><td><input type="number" id="mBal" value="18.25" oninput="runAreaCalc()"></td><td>1</td><td>1</td></tr>
                        <tr><td class="bg-gray">花台</td><td><input type="number" id="mFlower" value="2.2" oninput="runAreaCalc()"></td><td>1</td><td>1</td></tr>
                        <tr><td class="bg-gray">雨遮</td><td><input type="number" id="mRain" value="0" oninput="runAreaCalc()"></td><td>1</td><td>1</td></tr>
                        <tr><td class="bg-gray">平台</td><td><input type="number" id="mPlat" value="0" oninput="runAreaCalc()"></td><td>1</td><td>1</td></tr>
                        <tr><td class="bg-gray">其他</td><td><input type="number" id="mOth" value="0" oninput="runAreaCalc()"></td><td>1</td><td>1</td></tr>
                        
                        <tr class="bg-gray"><td colspan="4">共有部分 (公設)</td></tr>
                        <tr><td>公設 1</td><td><input type="number" id="mS1" value="5699.05" oninput="runAreaCalc()"></td><td><input type="number" id="dS1" value="100000" oninput="runAreaCalc()"></td><td><input type="number" id="nS1" value="256" oninput="runAreaCalc()"></td></tr>
                        <tr><td>公設 2</td><td><input type="number" id="mS2" value="260.88" oninput="runAreaCalc()"></td><td><input type="number" id="dS2" value="10000" oninput="runAreaCalc()"></td><td><input type="number" id="nS2" value="425" oninput="runAreaCalc()"></td></tr>
                        <tr><td>公設 3</td><td><input type="number" id="mS3" value="0" oninput="runAreaCalc()"></td><td><input type="number" id="dS3" value="1" oninput="runAreaCalc()"></td><td><input type="number" id="nS3" value="0" oninput="runAreaCalc()"></td></tr>
                        
                        <tr class="bg-gray"><td colspan="4">共有部分 (車位)</td></tr>
                        <tr><td>車位面積</td><td><input type="number" id="mCar" value="0" oninput="runAreaCalc()"></td><td><input type="number" id="dCar" value="1" oninput="runAreaCalc()"></td><td><input type="number" id="nCar" value="1" oninput="runAreaCalc()"></td></tr>
                    </tbody>
                </table>

                <div class="calc-summary">
                    <div class="summary-item">專有面積 (m²) <span id="outPri">84.11</span></div>
                    <div class="summary-item">共有面積 (m²) <span id="outPub">25.68</span></div>
                    <div class="summary-item">車位面積 (m²) <span id="outCar">0.00</span></div>
                    <div class="summary-item" style="color:var(--danger);">扣除後權狀坪數 <span id="outPing">33.21</span></div>
                </div>
                <button class="btn-apply" onclick="applyArea()">帶入「33.21」坪進行評定</button>
            </div>

            <div class="section-title">基本評定資料</div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>縣市</label><select id="city" onchange="initDistricts()"><option value="桃園市">桃園市</option><option value="彰化縣">彰化縣</option><option value="南投縣">南投縣</option></select></div>
                <div style="flex:1;"><label>行政區</label><select id="district" onchange="calculate()"></select></div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>案件類型</label><select id="caseType" onchange="calculate()"><option value="整層">整層</option><option value="套房">套房</option></select></div>
                <div style="flex:1;"><label>計算坪數</label><input type="number" id="area" inputmode="decimal" oninput="calculate()"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>屋齡(年)</label><input type="number" id="age" value="0" oninput="calculate()"></div>
                <div style="flex:1;"><label>簽約租金</label><input type="number" id="rent" inputmode="numeric" oninput="calculate()"></div>
            </div>
        </div>

        <div class="result-side">
            <div class="result-card">
                <div style="display:flex; justify-content:space-between;"><span>基準單價</span><span id="resRef" style="font-weight:bold;">0</span></div>
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
                <div style="text-align:right;">
                    <span style="font-size:0.9rem; font-weight:bold; color:#4a5568;">核定租金上限 (月/元)</span><br>
                    <span class="res-max-val" id="resMax">0</span>
                </div>
            </div>
            <div id="statusBox" class="status-init">請完成上方數據輸入</div>
            <button class="btn-apply" style="background:#718096;" onclick="location.reload()">重新填寫</button>
        </div>
    </div>
</div>

<script>
// 數據庫與核心邏輯 (延用 v11.0 桃園、彰化、南投全數據)
const masterData = { "桃園市": { "桃園區": { "整層": [780,770,755,735,720,700,680,650,620], "套房": [1120,1100,1080,1055,1025,1000,970,930,885] }, "中壢區": { "整層": [770,760,745,725,705,685,670,640,610], "套房": [1080,1065,1045,1020,995,965,940,900,855] }, "龜山區": { "整層": [855,840,825,805,785,760,740,710,675], "套房": [1225,1205,1185,1155,1125,1095,1065,1020,970] }, "蘆竹區": { "整層": [745,735,720,705,685,665,645,620,590], "套房": [1180,1160,1140,1110,1080,1050,1020,980,935] }, "八德區": { "整層": [735,720,710,690,675,655,635,610,580], "套房": [1045,1030,1010,985,960,935,905,870,830] }, "平鎮區": { "整層": [720,710,700,680,660,645,625,600,570], "套房": [900,885,870,850,830,805,780,750,715] }, "大園區": { "整層": [735,720,710,690,675,655,635,610,580], "套房": [1045,1030,1010,985,960,935,905,870,830] }, "觀音區": { "整層": [700,685,675,660,640,625,605,580,555], "套房": [900,885,870,850,830,805,780,750,715] }, "楊梅區": { "整層": [615,605,595,580,565,550,535,510,485], "套房": [830,815,805,780,760,740,720,690,660] }, "龍潭區": { "整層": [580,570,560,545,530,515,500,480,460], "套房": [830,815,805,780,760,740,720,690,660] }, "大溪區": { "整層": [565,555,550,535,520,505,490,470,450], "套房": [710,700,685,670,650,635,615,590,565] }, "新屋區": { "整層": [580,570,560,545,530,515,500,480,460], "套房": [625,615,605,590,575,560,545,520,495] }, "復興區": { "整層": [375,370,360,355,345,335,325,310,295], "套房": [385,380,375,365,355,345,335,320,305] } }, "彰化縣": { "彰化市": { "整層": [600,590,580,565,550,535,520,500,475], "套房": [745,735,720,705,685,665,645,620,590] }, "員林市": { "整層": [600,590,580,565,550,535,520,500,475], "套房": [675,665,650,635,620,600,585,560,535] }, "和美鎮": { "整層": [555,545,535,520,510,495,480,460,440], "套房": [565,555,550,535,520,505,490,470,450] }, "鹿港鎮": { "整層": [505,500,490,475,465,450,440,420,400], "套房": [565,555,550,535,520,505,490,470,450] } }, "南投縣": { "草屯鎮": { "整層": [625,615,605,590,575,560,545,520,495], "套房": [660,650,640,625,605,590,575,550,525] }, "南投市": { "整層": [600,590,580,565,550,535,520,500,475], "套房": [660,650,640,625,605,590,575,550,525] }, "埔里鎮": { "整層": [580,570,560,545,530,515,500,480,460], "套房": [600,590,580,565,550,535,520,500,475] } } };

// 面積換算邏輯
function runAreaCalc() {
    // 專有部分
    const pri = ["mMain", "mBal", "mFlower", "mRain", "mPlat", "mOth"].reduce((acc, id) => acc + parseFloat(document.getElementById(id).value || 0), 0);
    // 共有部分 (公設)
    const pub = (parseFloat(document.getElementById('mS1').value||0) * (parseFloat(document.getElementById('nS1').value||0)/parseFloat(document.getElementById('dS1').value||1))) +
                (parseFloat(document.getElementById('mS2').value||0) * (parseFloat(document.getElementById('nS2').value||0)/parseFloat(document.getElementById('dS2').value||1))) +
                (parseFloat(document.getElementById('mS3').value||0) * (parseFloat(document.getElementById('nS3').value||0)/parseFloat(document.getElementById('dS3').value||1)));
    // 車位部分
    const car = parseFloat(document.getElementById('mCar').value||0) * (parseFloat(document.getElementById('nCar').value||0)/parseFloat(document.getElementById('dCar').value||1));
    
    const finalPing = (pri + pub) * 0.3025; // 權狀面積(不含車位) = (專有+公設) * 0.3025
    
    document.getElementById('outPri').innerText = pri.toFixed(2);
    document.getElementById('outPub').innerText = pub.toFixed(2);
    document.getElementById('outCar').innerText = car.toFixed(2);
    document.getElementById('outPing').innerText = finalPing.toFixed(2);
    document.querySelector('.btn-apply').innerText = `帶入「${finalPing.toFixed(2)}」坪進行評定`;
}

function applyArea() {
    document.getElementById('area').value = document.getElementById('outPing').innerText;
    calculate();
}

function toggleView() {
    document.body.classList.toggle('mobile-mode');
    document.querySelector('.mode-toggle').innerText = document.body.classList.contains('mobile-mode') ? "切換電腦版" : "切換手機版";
}

function initDistricts() {
    const city = document.getElementById('city').value;
    const distSelect = document.getElementById('district');
    distSelect.innerHTML = "";
    Object.keys(masterData[city]).forEach(d => {
        let opt = document.createElement('option'); opt.value = d; opt.innerText = d;
        distSelect.appendChild(opt);
    });
    calculate();
}

function calculate() {
    const city = document.getElementById('city').value;
    const dist = document.getElementById('district').value;
    const type = document.getElementById('caseType').value;
    const age = parseFloat(document.getElementById('age').value) || 0;
    const area = parseFloat(document.getElementById('area').value) || 0;
    const rent = parseFloat(document.getElementById('rent').value) || 0;

    const priceList = masterData[city][dist] ? masterData[city][dist][type] : (type==="整層"?[400,390,385,375,365,355,345,330,315]:[385,380,375,365,355,345,335,320,305]);
    const ageIdx = Math.min(8, Math.floor(age / 5));
    const basePrice = priceList[ageIdx];
    
    document.getElementById('resRef').innerText = basePrice + " 元/坪";
    
    let cap = (city === "桃園市") ? (type === "整層" ? 35000 : 21000) : (type === "整層" ? 22000 : 13000);
    const maxVal = Math.min(basePrice * area, cap);
    document.getElementById('resMax').innerText = Math.round(maxVal).toLocaleString();

    const box = document.getElementById('statusBox');
    if (rent === 0 || area === 0) { box.innerText = "待輸入數據"; box.className = "status-init"; }
    else if (rent > maxVal) { box.innerText = "不符合 (超額)"; box.className = "status-danger"; }
    else { box.innerText = "符合標準"; box.className = "status-normal"; }
}

initDistricts();
runAreaCalc();
</script>
</body>
</html>
